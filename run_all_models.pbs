#!/bin/bash
#PBS -N other_models_exp
#PBS -q GPU-1
#PBS -o log/all_in_one.o%j
#PBS -e log/all_in_one.e%j
#PBS -l select=1:ncpus=8:ngpus=1:mem=64gb
#PBS -l walltime=20:00:00
#PBS -j oe

set -euo pipefail

cd "$PBS_O_WORKDIR"
mkdir -p log
exec > >(tee -a "log/all_in_one.o${PBS_JOBID}") 2>&1

echo "=== STARTING EFFICIENT FULL EXPERIMENT PIPELINE ==="
echo "START TIME: $(date)"
echo "Host: $(hostname)"
echo "CWD : $PWD"
echo "PBS_JOBID: $PBS_JOBID"

# 0. 設定ファイルのバックアップ
CONFIG_FILE="exp/configs/big5_vectors.yaml"
CONFIG_BAK="exp/configs/big5_vectors.yaml.bak"

if [ ! -f "$CONFIG_BAK" ]; then
    echo "[Step 0] Backing up $CONFIG_FILE to $CONFIG_BAK..."
    cp "$CONFIG_FILE" "$CONFIG_BAK"
else
    echo "[Step 0] Backup $CONFIG_BAK already exists. Restoring from it."
    cp "$CONFIG_BAK" "$CONFIG_FILE"
fi

# ==================== Tokens & PYTHONPATH ===============
export PROJECT_DIR="$PBS_O_WORKDIR"
set +x
if [ -f "$PROJECT_DIR/.hf_token" ]; then
  export HUGGINGFACE_HUB_TOKEN="$(head -n1 "$PROJECT_DIR/.hf_token" | tr -d '\r\n' | sed 's/^Bearer[[:space:]]\+//')"
fi
set -x

export PYTHONPATH="$PROJECT_DIR:$PROJECT_DIR/scripts:${PYTHONPATH:-}"

export OMP_NUM_THREADS=1
export CUDA_LAUNCH_BLOCKING=1
export HF_HUB_ENABLE_HF_TRANSFER=0
export PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
export TOKENIZERS_PARALLELISM=false

echo "[INFO] nvidia-smi:"
command -v nvidia-smi >/dev/null 2>&1 && nvidia-smi || echo "(no nvidia-smi)"

export PYTHON_BIN="$PROJECT_DIR/.venv/bin/python"

# ==================== 実験パラメータ ====================
TRAITS=("openness" "conscientiousness" "extraversion" "agreeableness" "neuroticism")
POOLINGS=("asst") #"last"
AXIS_MODES=("pairwise") #"cluster"

# (タグ, BaseID, InstructID)
ALPHAS_MISTRAL_7B_MODEL_PAIRS=(
  "mistral_7b mistralai/Mistral-7B-v0.3 mistralai/Mistral-7B-Instruct-v0.3"
)
ALPHAS_MISTRAL_7B="-3,-2.5,-2,-1.5,-1,0,1,1.5,2,2.5,3"
for line in "${ALPHAS_MISTRAL_7B_MODEL_PAIRS[@]}"; do
  set -- $line
  TAG=$1
  BASE_ID=$2
  INSTR_ID=$3

  for MODE in "${AXIS_MODES[@]}"; do
    for POOL in "${POOLINGS[@]}"; do
      echo "==== ${TAG} / pooling=${POOL} / mode=${MODE} ===="
      
      RESULTS_DIR_CLUSTER="exp/${TAG}/${POOL}_${MODE}_results"
      mkdir -p "${RESULTS_DIR_CLUSTER}"

      # Base: probe
      echo "[${TAG}][${POOL}][${MODE}] Base axes"
      sed -i "s|^model_name: .*|model_name: ${BASE_ID}|g" "$CONFIG_FILE"
      
      export POOLING="${POOL}"                      # 00_old 側で読むならここでセット
      export AX_BANK="exp/${TAG}/axes_base_${POOL}_${MODE}.npz"
      if [ "${MODE}" = "cluster" ]; then
        "$PYTHON_BIN" scripts/00_old_prepare_vectors.py --config "$CONFIG_FILE" # old 方式で軸作成
      else
        "$PYTHON_BIN" scripts/00_prepare_vectors.py --config "$CONFIG_FILE" # 新方式（pairwise）
      fi
      
      for trait in "${TRAITS[@]}"; do
        "$PYTHON_BIN" scripts/01_run_probe.py \
          --model      "${BASE_ID}" \
          --axes_bank  "exp/${TAG}/axes_base_${POOL}_${MODE}.npz" \
          --trait      "$trait" \
          --alpha_list="$ALPHAS_MISTRAL_7B" \
          --out        "${RESULTS_DIR_CLUSTER}/probe_base_${trait}.jsonl"
      done
      rm -f "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl"
      cat "${RESULTS_DIR_CLUSTER}/probe_base_"*.jsonl > "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl"

      # Instruct: prepare
      echo "[${TAG}][${POOL}][${MODE}] Instruct axes"
      sed -i "s|^model_name: .*|model_name: ${INSTR_ID}|g" "$CONFIG_FILE"
      
      export POOLING="${POOL}"
      export AX_BANK="exp/${TAG}/axes_instruct_${POOL}_${MODE}.npz"
      if [ "${MODE}" = "cluster" ]; then
        "$PYTHON_BIN" scripts/00_old_prepare_vectors.py --config "$CONFIG_FILE"
      else
        "$PYTHON_BIN" scripts/00_prepare_vectors.py --config "$CONFIG_FILE"
      fi
      
      # Instruct: probe
      for trait in "${TRAITS[@]}"; do
        "$PYTHON_BIN" scripts/01_run_probe.py \
          --model      "${INSTR_ID}" \
          --axes_bank  "exp/${TAG}/axes_instruct_${POOL}_${MODE}.npz" \
          --trait      "$trait" \
          --alpha_list="$ALPHAS_MISTRAL_7B" \
          --out        "${RESULTS_DIR_CLUSTER}/probe_instruct_${trait}.jsonl"
      done
      rm -f "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl"
      cat "${RESULTS_DIR_CLUSTER}/probe_instruct_"*.jsonl > "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl"
    
      # Phase 2: ベクトル [全レイヤー] 比較分析 (幾何)
      echo "[${TAG}][${POOL}][${MODE}] Phase 2: compare vector norms (all layers)"
      "$PYTHON_BIN" scripts/02_compare_vector_norms.py \
          --model_base     "${BASE_ID}" \
          --model_instruct "${INSTR_ID}" \
          --config         "$CONFIG_FILE" \
          --out            "exp/${TAG}/norm_comparison_all_layers_${POOL}_${MODE}.jsonl" \
          --pooling        "${POOL}"      \
          --axis_mode      "${MODE}"      
      
      # Phase 3: 層別ノルム比 / ステア効果プロット
      echo "[${TAG}][${POOL}][${MODE}] Phase 3: plotting (steer + norm + cosine)"
      "$PYTHON_BIN" scripts/03_plot_results.py \
          --results_dir "${RESULTS_DIR_CLUSTER}" \
          --out_dir     "${RESULTS_DIR_CLUSTER}/plots" \
          --norm_path   "exp/${TAG}/norm_comparison_all_layers_${POOL}_${MODE}.jsonl"
      
      # Phase 4: 傾き解析 & 可視化
      echo "[${TAG}][${POOL}][${MODE}] Phase 4: analyze slopes"
      "$PYTHON_BIN" scripts/02_probe_slopes_from_logs.py \
          --base_json  "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl" \
          --instr_json "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl" \
          --out_csv    "${RESULTS_DIR_CLUSTER}/slopes_${POOL}_${MODE}.csv" \
          --pooling "${POOL}" --axis_mode "${MODE}"

      "$PYTHON_BIN" scripts/03_slopes_visualize.py \
          --input_dir "${RESULTS_DIR_CLUSTER}" \
          --out_dir   "${RESULTS_DIR_CLUSTER}/plots" \
          --value_col slope_delta_score_vs_alpha01
      
      # Phase 5: 崩壊度指標分析
      echo "[${TAG}][${POOL}][${MODE}] Phase 5: collapse analysis"
      "$PYTHON_BIN" scripts/02_collapse_from_logs.py \
          --base_json  "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl" \
          --instr_json "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl" \
          --out_csv    "${RESULTS_DIR_CLUSTER}/collapse_${POOL}_${MODE}.csv" \
          --pooling "${POOL}" \
          --axis_mode "${MODE}"

      "$PYTHON_BIN" scripts/03_collapse_visualize.py \
          --input_path "${RESULTS_DIR_CLUSTER}/collapse_${POOL}_${MODE}.csv" \
          --out_dir    "${RESULTS_DIR_CLUSTER}/plots/collapse"

      "$PYTHON_BIN" scripts/04_repetition_only.py \
        --base_json  "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl" \
        --instr_json "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl" \
        --out_csv    "${RESULTS_DIR_CLUSTER}/repetition_${POOL}_${MODE}.csv" 
        
      "$PYTHON_BIN" scripts/05_repetition_vs_alpha.py \
        --csv     "${RESULTS_DIR_CLUSTER}/repetition_${POOL}_${MODE}.csv" \
        --out_dir "${RESULTS_DIR_CLUSTER}/plots/repetition"      
      
      echo "---- ${TAG} / pooling=${POOL} / mode=${MODE} DONE ----"
    done
  done
  echo "==== ${TAG} END: Finished all pooling settings ===="
  echo "-----------------------------------------"
done

ALPHAS_LLAMA3_8B_MODEL_PAIRS=(
  "llama3_8b meta-llama/Meta-Llama-3-8B meta-llama/Meta-Llama-3-8B-Instruct"
)
ALPHAS_LLAMA3_8B="-10,-8,-6,-4,-2,0,2,4,6,8,10"
for line in "${ALPHAS_LLAMA3_8B_MODEL_PAIRS[@]}"; do
  set -- $line
  TAG=$1
  BASE_ID=$2
  INSTR_ID=$3

  for MODE in "${AXIS_MODES[@]}"; do
    for POOL in "${POOLINGS[@]}"; do
      echo "==== ${TAG} / pooling=${POOL} / mode=${MODE} ===="
      
      RESULTS_DIR_CLUSTER="exp/${TAG}/${POOL}_${MODE}_results"
      mkdir -p "${RESULTS_DIR_CLUSTER}"

      # Base: probe
      echo "[${TAG}][${POOL}][${MODE}] Base axes"
      sed -i "s|^model_name: .*|model_name: ${BASE_ID}|g" "$CONFIG_FILE"
      
      export POOLING="${POOL}"                      # 00_old 側で読むならここでセット
      export AX_BANK="exp/${TAG}/axes_base_${POOL}_${MODE}.npz"
      if [ "${MODE}" = "cluster" ]; then
        "$PYTHON_BIN" scripts/00_old_prepare_vectors.py --config "$CONFIG_FILE" # old 方式で軸作成
      else
        "$PYTHON_BIN" scripts/00_prepare_vectors.py --config "$CONFIG_FILE" # 新方式（pairwise）
      fi
      
      for trait in "${TRAITS[@]}"; do
        "$PYTHON_BIN" scripts/01_run_probe.py \
          --model      "${BASE_ID}" \
          --axes_bank  "exp/${TAG}/axes_base_${POOL}_${MODE}.npz" \
          --trait      "$trait" \
          --alpha_list="$ALPHAS_LLAMA3_8B" \
          --out        "${RESULTS_DIR_CLUSTER}/probe_base_${trait}.jsonl"
      done
      rm -f "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl"
      cat "${RESULTS_DIR_CLUSTER}/probe_base_"*.jsonl > "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl"

      # Instruct: prepare
      echo "[${TAG}][${POOL}][${MODE}] Instruct axes"
      sed -i "s|^model_name: .*|model_name: ${INSTR_ID}|g" "$CONFIG_FILE"
      
      export POOLING="${POOL}"
      export AX_BANK="exp/${TAG}/axes_instruct_${POOL}_${MODE}.npz"
      if [ "${MODE}" = "cluster" ]; then
        "$PYTHON_BIN" scripts/00_old_prepare_vectors.py --config "$CONFIG_FILE"
      else
        "$PYTHON_BIN" scripts/00_prepare_vectors.py --config "$CONFIG_FILE"
      fi
      
      # Instruct: probe
      for trait in "${TRAITS[@]}"; do
        "$PYTHON_BIN" scripts/01_run_probe.py \
          --model      "${INSTR_ID}" \
          --axes_bank  "exp/${TAG}/axes_instruct_${POOL}_${MODE}.npz" \
          --trait      "$trait" \
          --alpha_list="$ALPHAS_LLAMA3_8B" \
          --out        "${RESULTS_DIR_CLUSTER}/probe_instruct_${trait}.jsonl"
      done
      rm -f "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl"
      cat "${RESULTS_DIR_CLUSTER}/probe_instruct_"*.jsonl > "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl"
    
      # Phase 2: ベクトル [全レイヤー] 比較分析 (幾何)
      echo "[${TAG}][${POOL}][${MODE}] Phase 2: compare vector norms (all layers)"
      "$PYTHON_BIN" scripts/02_compare_vector_norms.py \
          --model_base     "${BASE_ID}" \
          --model_instruct "${INSTR_ID}" \
          --config         "$CONFIG_FILE" \
          --out            "exp/${TAG}/norm_comparison_all_layers_${POOL}_${MODE}.jsonl" \
          --pooling        "${POOL}"      \
          --axis_mode      "${MODE}"      
      
      # Phase 3: 層別ノルム比 / ステア効果プロット
      echo "[${TAG}][${POOL}][${MODE}] Phase 3: plotting (steer + norm + cosine)"
      "$PYTHON_BIN" scripts/03_plot_results.py \
          --results_dir "${RESULTS_DIR_CLUSTER}" \
          --out_dir     "${RESULTS_DIR_CLUSTER}/plots" \
          --norm_path   "exp/${TAG}/norm_comparison_all_layers_${POOL}_${MODE}.jsonl"
      
      # Phase 4: 傾き解析 & 可視化
      echo "[${TAG}][${POOL}][${MODE}] Phase 4: analyze slopes"
      "$PYTHON_BIN" scripts/02_probe_slopes_from_logs.py \
          --base_json  "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl" \
          --instr_json "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl" \
          --out_csv    "${RESULTS_DIR_CLUSTER}/slopes_${POOL}_${MODE}.csv" \
          --pooling "${POOL}" --axis_mode "${MODE}"

      "$PYTHON_BIN" scripts/03_slopes_visualize.py \
          --input_dir "${RESULTS_DIR_CLUSTER}" \
          --out_dir   "${RESULTS_DIR_CLUSTER}/plots"
      
      # Phase 5: 崩壊度指標分析
      echo "[${TAG}][${POOL}][${MODE}] Phase 5: collapse analysis"
      "$PYTHON_BIN" scripts/02_collapse_from_logs.py \
          --base_json  "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl" \
          --instr_json "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl" \
          --out_csv    "${RESULTS_DIR_CLUSTER}/collapse_${POOL}_${MODE}.csv" \
          --pooling "${POOL}" \
          --axis_mode "${MODE}"

      "$PYTHON_BIN" scripts/03_collapse_visualize.py \
          --input_path "${RESULTS_DIR_CLUSTER}/collapse_${POOL}_${MODE}.csv" \
          --out_dir    "${RESULTS_DIR_CLUSTER}/plots/collapse"

      "$PYTHON_BIN" scripts/04_repetition_only.py \
        --base_json  "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl" \
        --instr_json "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl" \
        --out_csv    "${RESULTS_DIR_CLUSTER}/repetition_${POOL}_${MODE}.csv" 
        
      "$PYTHON_BIN" scripts/05_repetition_vs_alpha.py \
        --csv     "${RESULTS_DIR_CLUSTER}/repetition_${POOL}_${MODE}.csv" \
        --out_dir "${RESULTS_DIR_CLUSTER}/plots/repetition"
      
      echo "---- ${TAG} / pooling=${POOL} / mode=${MODE} DONE ----"
    done
  done
  echo "==== ${TAG} END: Finished all pooling settings ===="
  echo "-----------------------------------------"
done

ALPHAS_LLAMA2_7B_MODEL_PAIRS=(
  "llama2_7b  meta-llama/Llama-2-7b-hf       meta-llama/Llama-2-7b-chat-hf"
)
ALPHAS_LLAMA2_7B="-30,-25,-20,-15,-10,0,10,15,20,25,30"
for line in "${ALPHAS_LLAMA2_7B_MODEL_PAIRS[@]}"; do
  set -- $line
  TAG=$1
  BASE_ID=$2
  INSTR_ID=$3

  for MODE in "${AXIS_MODES[@]}"; do
    for POOL in "${POOLINGS[@]}"; do
      echo "==== ${TAG} / pooling=${POOL} / mode=${MODE} ===="
      
      RESULTS_DIR_CLUSTER="exp/${TAG}/${POOL}_${MODE}_results"
      mkdir -p "${RESULTS_DIR_CLUSTER}"

      # Base: probe
      echo "[${TAG}][${POOL}][${MODE}] Base axes"
      sed -i "s|^model_name: .*|model_name: ${BASE_ID}|g" "$CONFIG_FILE"
      
      export POOLING="${POOL}"                      # 00_old 側で読むならここでセット
      export AX_BANK="exp/${TAG}/axes_base_${POOL}_${MODE}.npz"
      if [ "${MODE}" = "cluster" ]; then
        "$PYTHON_BIN" scripts/00_old_prepare_vectors.py --config "$CONFIG_FILE" # old 方式で軸作成
      else
        "$PYTHON_BIN" scripts/00_prepare_vectors.py --config "$CONFIG_FILE" # 新方式（pairwise）
      fi
      
      for trait in "${TRAITS[@]}"; do
        "$PYTHON_BIN" scripts/01_run_probe.py \
          --model      "${BASE_ID}" \
          --axes_bank  "exp/${TAG}/axes_base_${POOL}_${MODE}.npz" \
          --trait      "$trait" \
          --alpha_list="$ALPHAS_LLAMA2_7B" \
          --out        "${RESULTS_DIR_CLUSTER}/probe_base_${trait}.jsonl"
      done
      rm -f "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl"
      cat "${RESULTS_DIR_CLUSTER}/probe_base_"*.jsonl > "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl"

      # Instruct: prepare
      echo "[${TAG}][${POOL}][${MODE}] Instruct axes"
      sed -i "s|^model_name: .*|model_name: ${INSTR_ID}|g" "$CONFIG_FILE"
      
      export POOLING="${POOL}"
      export AX_BANK="exp/${TAG}/axes_instruct_${POOL}_${MODE}.npz"
      if [ "${MODE}" = "cluster" ]; then
        "$PYTHON_BIN" scripts/00_old_prepare_vectors.py --config "$CONFIG_FILE"
      else
        "$PYTHON_BIN" scripts/00_prepare_vectors.py --config "$CONFIG_FILE"
      fi
      
      # Instruct: probe
      for trait in "${TRAITS[@]}"; do
        "$PYTHON_BIN" scripts/01_run_probe.py \
          --model      "${INSTR_ID}" \
          --axes_bank  "exp/${TAG}/axes_instruct_${POOL}_${MODE}.npz" \
          --trait      "$trait" \
          --alpha_list="$ALPHAS_LLAMA2_7B" \
          --out        "${RESULTS_DIR_CLUSTER}/probe_instruct_${trait}.jsonl"
      done
      rm -f "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl"
      cat "${RESULTS_DIR_CLUSTER}/probe_instruct_"*.jsonl > "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl"
    
      # Phase 2: ベクトル [全レイヤー] 比較分析 (幾何)
      echo "[${TAG}][${POOL}][${MODE}] Phase 2: compare vector norms (all layers)"
      "$PYTHON_BIN" scripts/02_compare_vector_norms.py \
          --model_base     "${BASE_ID}" \
          --model_instruct "${INSTR_ID}" \
          --config         "$CONFIG_FILE" \
          --out            "exp/${TAG}/norm_comparison_all_layers_${POOL}_${MODE}.jsonl" \
          --pooling        "${POOL}"      \
          --axis_mode      "${MODE}"      
      
      # Phase 3: 層別ノルム比 / ステア効果プロット
      echo "[${TAG}][${POOL}][${MODE}] Phase 3: plotting (steer + norm + cosine)"
      "$PYTHON_BIN" scripts/03_plot_results.py \
          --results_dir "${RESULTS_DIR_CLUSTER}" \
          --out_dir     "${RESULTS_DIR_CLUSTER}/plots" \
          --norm_path   "exp/${TAG}/norm_comparison_all_layers_${POOL}_${MODE}.jsonl"
      
      # Phase 4: 傾き解析 & 可視化
      echo "[${TAG}][${POOL}][${MODE}] Phase 4: analyze slopes"
      "$PYTHON_BIN" scripts/02_probe_slopes_from_logs.py \
          --base_json  "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl" \
          --instr_json "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl" \
          --out_csv    "${RESULTS_DIR_CLUSTER}/slopes_${POOL}_${MODE}.csv" \
          --pooling "${POOL}" --axis_mode "${MODE}"

      "$PYTHON_BIN" scripts/03_slopes_visualize.py \
          --input_dir "${RESULTS_DIR_CLUSTER}" \
          --out_dir   "${RESULTS_DIR_CLUSTER}/plots" 
      
      # Phase 5: 崩壊度指標分析
      echo "[${TAG}][${POOL}][${MODE}] Phase 5: collapse analysis"
      "$PYTHON_BIN" scripts/02_collapse_from_logs.py \
          --base_json  "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl" \
          --instr_json "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl" \
          --out_csv    "${RESULTS_DIR_CLUSTER}/collapse_${POOL}_${MODE}.csv" \
          --pooling "${POOL}" \
          --axis_mode "${MODE}"

      "$PYTHON_BIN" scripts/03_collapse_visualize.py \
          --input_path "${RESULTS_DIR_CLUSTER}/collapse_${POOL}_${MODE}.csv" \
          --out_dir    "${RESULTS_DIR_CLUSTER}/plots/collapse"

      "$PYTHON_BIN" scripts/04_repetition_only.py \
        --base_json  "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl" \
        --instr_json "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl" \
        --out_csv    "${RESULTS_DIR_CLUSTER}/repetition_${POOL}_${MODE}.csv" 
        
      "$PYTHON_BIN" scripts/05_repetition_vs_alpha.py \
        --csv     "${RESULTS_DIR_CLUSTER}/repetition_${POOL}_${MODE}.csv" \
        --out_dir "${RESULTS_DIR_CLUSTER}/plots/repetition"      
      
      echo "---- ${TAG} / pooling=${POOL} / mode=${MODE} DONE ----"
    done
  done
  echo "==== ${TAG} END: Finished all pooling settings ===="
  echo "-----------------------------------------"
done

ALPHAS_LLAMA2_13B_MODEL_PAIRS=(
  "llama2_13b meta-llama/Llama-2-13b-hf      meta-llama/Llama-2-13b-chat-hf"
)
ALPHAS_LLAMA2_13B="-50,-40,-30,-20,-10,0,10,20,30,40,50"
for line in "${ALPHAS_LLAMA2_13B_MODEL_PAIRS[@]}"; do
  set -- $line
  TAG=$1
  BASE_ID=$2
  INSTR_ID=$3

  for MODE in "${AXIS_MODES[@]}"; do
    for POOL in "${POOLINGS[@]}"; do
      echo "==== ${TAG} / pooling=${POOL} / mode=${MODE} ===="
      
      RESULTS_DIR_CLUSTER="exp/${TAG}/${POOL}_${MODE}_results"
      mkdir -p "${RESULTS_DIR_CLUSTER}"

      # Base: probe
      echo "[${TAG}][${POOL}][${MODE}] Base axes"
      sed -i "s|^model_name: .*|model_name: ${BASE_ID}|g" "$CONFIG_FILE"
      
      export POOLING="${POOL}"                      # 00_old 側で読むならここでセット
      export AX_BANK="exp/${TAG}/axes_base_${POOL}_${MODE}.npz"
      if [ "${MODE}" = "cluster" ]; then
        "$PYTHON_BIN" scripts/00_old_prepare_vectors.py --config "$CONFIG_FILE" # old 方式で軸作成
      else
        "$PYTHON_BIN" scripts/00_prepare_vectors.py --config "$CONFIG_FILE" # 新方式（pairwise）
      fi
      
      for trait in "${TRAITS[@]}"; do
        "$PYTHON_BIN" scripts/01_run_probe.py \
          --model      "${BASE_ID}" \
          --axes_bank  "exp/${TAG}/axes_base_${POOL}_${MODE}.npz" \
          --trait      "$trait" \
          --alpha_list="$ALPHAS_LLAMA2_13B" \
          --out        "${RESULTS_DIR_CLUSTER}/probe_base_${trait}.jsonl"
      done
      rm -f "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl"
      cat "${RESULTS_DIR_CLUSTER}/probe_base_"*.jsonl > "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl"

      # Instruct: prepare
      echo "[${TAG}][${POOL}][${MODE}] Instruct axes"
      sed -i "s|^model_name: .*|model_name: ${INSTR_ID}|g" "$CONFIG_FILE"
      
      export POOLING="${POOL}"
      export AX_BANK="exp/${TAG}/axes_instruct_${POOL}_${MODE}.npz"
      if [ "${MODE}" = "cluster" ]; then
        "$PYTHON_BIN" scripts/00_old_prepare_vectors.py --config "$CONFIG_FILE"
      else
        "$PYTHON_BIN" scripts/00_prepare_vectors.py --config "$CONFIG_FILE"
      fi
      
      # Instruct: probe
      for trait in "${TRAITS[@]}"; do
        "$PYTHON_BIN" scripts/01_run_probe.py \
          --model      "${INSTR_ID}" \
          --axes_bank  "exp/${TAG}/axes_instruct_${POOL}_${MODE}.npz" \
          --trait      "$trait" \
          --alpha_list="$ALPHAS_LLAMA2_13B" \
          --out        "${RESULTS_DIR_CLUSTER}/probe_instruct_${trait}.jsonl"
      done
      rm -f "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl"
      cat "${RESULTS_DIR_CLUSTER}/probe_instruct_"*.jsonl > "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl"
    
      # Phase 2: ベクトル [全レイヤー] 比較分析 (幾何)
      echo "[${TAG}][${POOL}][${MODE}] Phase 2: compare vector norms (all layers)"
      "$PYTHON_BIN" scripts/02_compare_vector_norms.py \
          --model_base     "${BASE_ID}" \
          --model_instruct "${INSTR_ID}" \
          --config         "$CONFIG_FILE" \
          --out            "exp/${TAG}/norm_comparison_all_layers_${POOL}_${MODE}.jsonl" \
          --pooling        "${POOL}"      \
          --axis_mode      "${MODE}"      
      
      # Phase 3: 層別ノルム比 / ステア効果プロット
      echo "[${TAG}][${POOL}][${MODE}] Phase 3: plotting (steer + norm + cosine)"
      "$PYTHON_BIN" scripts/03_plot_results.py \
          --results_dir "${RESULTS_DIR_CLUSTER}" \
          --out_dir     "${RESULTS_DIR_CLUSTER}/plots" \
          --norm_path   "exp/${TAG}/norm_comparison_all_layers_${POOL}_${MODE}.jsonl"
      
      # Phase 4: 傾き解析 & 可視化
      echo "[${TAG}][${POOL}][${MODE}] Phase 4: analyze slopes"
      "$PYTHON_BIN" scripts/02_probe_slopes_from_logs.py \
          --base_json  "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl" \
          --instr_json "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl" \
          --out_csv    "${RESULTS_DIR_CLUSTER}/slopes_${POOL}_${MODE}.csv" \
          --pooling "${POOL}" --axis_mode "${MODE}"

      "$PYTHON_BIN" scripts/03_slopes_visualize.py \
          --input_dir "${RESULTS_DIR_CLUSTER}" \
          --out_dir   "${RESULTS_DIR_CLUSTER}/plots" 
      
      # Phase 5: 崩壊度指標分析
      echo "[${TAG}][${POOL}][${MODE}] Phase 5: collapse analysis"
      "$PYTHON_BIN" scripts/02_collapse_from_logs.py \
          --base_json  "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl" \
          --instr_json "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl" \
          --out_csv    "${RESULTS_DIR_CLUSTER}/collapse_${POOL}_${MODE}.csv" \
          --pooling "${POOL}" \
          --axis_mode "${MODE}"

      "$PYTHON_BIN" scripts/03_collapse_visualize.py \
          --input_path "${RESULTS_DIR_CLUSTER}/collapse_${POOL}_${MODE}.csv" \
          --out_dir    "${RESULTS_DIR_CLUSTER}/plots/collapse"

      "$PYTHON_BIN" scripts/04_repetition_only.py \
        --base_json  "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl" \
        --instr_json "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl" \
        --out_csv    "${RESULTS_DIR_CLUSTER}/repetition_${POOL}_${MODE}.csv" 
        
      "$PYTHON_BIN" scripts/05_repetition_vs_alpha.py \
        --csv     "${RESULTS_DIR_CLUSTER}/repetition_${POOL}_${MODE}.csv" \
        --out_dir "${RESULTS_DIR_CLUSTER}/plots/repetition"
      
      echo "---- ${TAG} / pooling=${POOL} / mode=${MODE} DONE ----"
    done
  done
  echo "==== ${TAG} END: Finished all pooling settings ===="
  echo "-----------------------------------------"
done

ALPHAS_QWEN2_MODEL_PAIRS=(
  "qwen2_7b Qwen/Qwen2-7B Qwen/Qwen2-7B-Instruct"
)
ALPHAS_QWEN2="-90,-70,-50,-30,-10,0,10,30,50,70,90"
for line in "${ALPHAS_QWEN2_MODEL_PAIRS[@]}"; do
  set -- $line
  TAG=$1
  BASE_ID=$2
  INSTR_ID=$3

  for MODE in "${AXIS_MODES[@]}"; do
    for POOL in "${POOLINGS[@]}"; do
      echo "==== ${TAG} / pooling=${POOL} / mode=${MODE} ===="
      
      RESULTS_DIR_CLUSTER="exp/${TAG}/${POOL}_${MODE}_results"
      mkdir -p "${RESULTS_DIR_CLUSTER}"

      # Base: probe
      echo "[${TAG}][${POOL}][${MODE}] Base axes"
      sed -i "s|^model_name: .*|model_name: ${BASE_ID}|g" "$CONFIG_FILE"
      
      export POOLING="${POOL}"                      # 00_old 側で読むならここでセット
      export AX_BANK="exp/${TAG}/axes_base_${POOL}_${MODE}.npz"
      if [ "${MODE}" = "cluster" ]; then
        "$PYTHON_BIN" scripts/00_old_prepare_vectors.py --config "$CONFIG_FILE" # old 方式で軸作成
      else
        "$PYTHON_BIN" scripts/00_prepare_vectors.py --config "$CONFIG_FILE" # 新方式（pairwise）
      fi
      
      for trait in "${TRAITS[@]}"; do
        "$PYTHON_BIN" scripts/01_run_probe.py \
          --model      "${BASE_ID}" \
          --axes_bank  "exp/${TAG}/axes_base_${POOL}_${MODE}.npz" \
          --trait      "$trait" \
          --alpha_list="$ALPHAS_QWEN2" \
          --out        "${RESULTS_DIR_CLUSTER}/probe_base_${trait}.jsonl"
      done
      rm -f "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl"
      cat "${RESULTS_DIR_CLUSTER}/probe_base_"*.jsonl > "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl"

      # Instruct: prepare
      echo "[${TAG}][${POOL}][${MODE}] Instruct axes"
      sed -i "s|^model_name: .*|model_name: ${INSTR_ID}|g" "$CONFIG_FILE"
      
      export POOLING="${POOL}"
      export AX_BANK="exp/${TAG}/axes_instruct_${POOL}_${MODE}.npz"
      if [ "${MODE}" = "cluster" ]; then
        "$PYTHON_BIN" scripts/00_old_prepare_vectors.py --config "$CONFIG_FILE"
      else
        "$PYTHON_BIN" scripts/00_prepare_vectors.py --config "$CONFIG_FILE"
      fi
      
      # Instruct: probe
      for trait in "${TRAITS[@]}"; do
        "$PYTHON_BIN" scripts/01_run_probe.py \
          --model      "${INSTR_ID}" \
          --axes_bank  "exp/${TAG}/axes_instruct_${POOL}_${MODE}.npz" \
          --trait      "$trait" \
          --alpha_list="$ALPHAS_QWEN2" \
          --out        "${RESULTS_DIR_CLUSTER}/probe_instruct_${trait}.jsonl"
      done
      rm -f "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl"
      cat "${RESULTS_DIR_CLUSTER}/probe_instruct_"*.jsonl > "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl"
    
      # Phase 2: ベクトル [全レイヤー] 比較分析 (幾何)
      echo "[${TAG}][${POOL}][${MODE}] Phase 2: compare vector norms (all layers)"
      "$PYTHON_BIN" scripts/02_compare_vector_norms.py \
          --model_base     "${BASE_ID}" \
          --model_instruct "${INSTR_ID}" \
          --config         "$CONFIG_FILE" \
          --out            "exp/${TAG}/norm_comparison_all_layers_${POOL}_${MODE}.jsonl" \
          --pooling        "${POOL}"      \
          --axis_mode      "${MODE}"      
      
      # Phase 3: 層別ノルム比 / ステア効果プロット
      echo "[${TAG}][${POOL}][${MODE}] Phase 3: plotting (steer + norm + cosine)"
      "$PYTHON_BIN" scripts/03_plot_results.py \
          --results_dir "${RESULTS_DIR_CLUSTER}" \
          --out_dir     "${RESULTS_DIR_CLUSTER}/plots" \
          --norm_path   "exp/${TAG}/norm_comparison_all_layers_${POOL}_${MODE}.jsonl"
      
      # Phase 4: 傾き解析 & 可視化
      echo "[${TAG}][${POOL}][${MODE}] Phase 4: analyze slopes"
      "$PYTHON_BIN" scripts/02_probe_slopes_from_logs.py \
          --base_json  "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl" \
          --instr_json "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl" \
          --out_csv    "${RESULTS_DIR_CLUSTER}/slopes_${POOL}_${MODE}.csv" \
          --pooling "${POOL}" --axis_mode "${MODE}"

      "$PYTHON_BIN" scripts/03_slopes_visualize.py \
          --input_dir "${RESULTS_DIR_CLUSTER}" \
          --out_dir   "${RESULTS_DIR_CLUSTER}/plots" 
      
      # Phase 5: 崩壊度指標分析
      echo "[${TAG}][${POOL}][${MODE}] Phase 5: collapse analysis"
      "$PYTHON_BIN" scripts/02_collapse_from_logs.py \
          --base_json  "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl" \
          --instr_json "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl" \
          --out_csv    "${RESULTS_DIR_CLUSTER}/collapse_${POOL}_${MODE}.csv" \
          --pooling "${POOL}" \
          --axis_mode "${MODE}"

      "$PYTHON_BIN" scripts/03_collapse_visualize.py \
          --input_path "${RESULTS_DIR_CLUSTER}/collapse_${POOL}_${MODE}.csv" \
          --out_dir    "${RESULTS_DIR_CLUSTER}/plots/collapse"

      "$PYTHON_BIN" scripts/04_repetition_only.py \
        --base_json  "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl" \
        --instr_json "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl" \
        --out_csv    "${RESULTS_DIR_CLUSTER}/repetition_${POOL}_${MODE}.csv" 
        
      "$PYTHON_BIN" scripts/05_repetition_vs_alpha.py \
        --csv     "${RESULTS_DIR_CLUSTER}/repetition_${POOL}_${MODE}.csv" \
        --out_dir "${RESULTS_DIR_CLUSTER}/plots/repetition"
      
      echo "---- ${TAG} / pooling=${POOL} / mode=${MODE} DONE ----"
    done
  done
  echo "==== ${TAG} END: Finished all pooling settings ===="
  echo "-----------------------------------------"
done

ALPHAS_GEMMA2_MODEL_PAIRS=(
  "gemma2_9b google/gemma-2-9b google/gemma-2-9b-it"
)
ALPHAS_GEMMA2="-500,-400,-300,-200,-100,0,100,200,300,400,500"
for line in "${ALPHAS_GEMMA2_MODEL_PAIRS[@]}"; do
  set -- $line
  TAG=$1
  BASE_ID=$2
  INSTR_ID=$3

  for MODE in "${AXIS_MODES[@]}"; do
    for POOL in "${POOLINGS[@]}"; do
      echo "==== ${TAG} / pooling=${POOL} / mode=${MODE} ===="
      
      RESULTS_DIR_CLUSTER="exp/${TAG}/${POOL}_${MODE}_results"
      mkdir -p "${RESULTS_DIR_CLUSTER}"

      # Base: probe
      echo "[${TAG}][${POOL}][${MODE}] Base axes"
      sed -i "s|^model_name: .*|model_name: ${BASE_ID}|g" "$CONFIG_FILE"
      
      export POOLING="${POOL}"                      # 00_old 側で読むならここでセット
      export AX_BANK="exp/${TAG}/axes_base_${POOL}_${MODE}.npz"
      if [ "${MODE}" = "cluster" ]; then
        "$PYTHON_BIN" scripts/00_old_prepare_vectors.py --config "$CONFIG_FILE" # old 方式で軸作成
      else
        "$PYTHON_BIN" scripts/00_prepare_vectors.py --config "$CONFIG_FILE" # 新方式（pairwise）
      fi
      
      for trait in "${TRAITS[@]}"; do
        "$PYTHON_BIN" scripts/01_run_probe.py \
          --model      "${BASE_ID}" \
          --axes_bank  "exp/${TAG}/axes_base_${POOL}_${MODE}.npz" \
          --trait      "$trait" \
          --alpha_list="$ALPHAS_GEMMA2" \
          --out        "${RESULTS_DIR_CLUSTER}/probe_base_${trait}.jsonl"
      done
      rm -f "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl"
      cat "${RESULTS_DIR_CLUSTER}/probe_base_"*.jsonl > "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl"

      # Instruct: prepare
      echo "[${TAG}][${POOL}][${MODE}] Instruct axes"
      sed -i "s|^model_name: .*|model_name: ${INSTR_ID}|g" "$CONFIG_FILE"
      
      export POOLING="${POOL}"
      export AX_BANK="exp/${TAG}/axes_instruct_${POOL}_${MODE}.npz"
      if [ "${MODE}" = "cluster" ]; then
        "$PYTHON_BIN" scripts/00_old_prepare_vectors.py --config "$CONFIG_FILE"
      else
        "$PYTHON_BIN" scripts/00_prepare_vectors.py --config "$CONFIG_FILE"
      fi
      
      # Instruct: probe
      for trait in "${TRAITS[@]}"; do
        "$PYTHON_BIN" scripts/01_run_probe.py \
          --model      "${INSTR_ID}" \
          --axes_bank  "exp/${TAG}/axes_instruct_${POOL}_${MODE}.npz" \
          --trait      "$trait" \
          --alpha_list="$ALPHAS_GEMMA2" \
          --out        "${RESULTS_DIR_CLUSTER}/probe_instruct_${trait}.jsonl"
      done
      rm -f "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl"
      cat "${RESULTS_DIR_CLUSTER}/probe_instruct_"*.jsonl > "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl"
    
      # Phase 2: ベクトル [全レイヤー] 比較分析 (幾何)
      echo "[${TAG}][${POOL}][${MODE}] Phase 2: compare vector norms (all layers)"
      "$PYTHON_BIN" scripts/02_compare_vector_norms.py \
          --model_base     "${BASE_ID}" \
          --model_instruct "${INSTR_ID}" \
          --config         "$CONFIG_FILE" \
          --out            "exp/${TAG}/norm_comparison_all_layers_${POOL}_${MODE}.jsonl" \
          --pooling        "${POOL}"      \
          --axis_mode      "${MODE}"      
      
      # Phase 3: 層別ノルム比 / ステア効果プロット
      echo "[${TAG}][${POOL}][${MODE}] Phase 3: plotting (steer + norm + cosine)"
      "$PYTHON_BIN" scripts/03_plot_results.py \
          --results_dir "${RESULTS_DIR_CLUSTER}" \
          --out_dir     "${RESULTS_DIR_CLUSTER}/plots" \
          --norm_path   "exp/${TAG}/norm_comparison_all_layers_${POOL}_${MODE}.jsonl"
      
      # Phase 4: 傾き解析 & 可視化
      echo "[${TAG}][${POOL}][${MODE}] Phase 4: analyze slopes"
      "$PYTHON_BIN" scripts/02_probe_slopes_from_logs.py \
          --base_json  "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl" \
          --instr_json "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl" \
          --out_csv    "${RESULTS_DIR_CLUSTER}/slopes_${POOL}_${MODE}.csv" \
          --pooling "${POOL}" --axis_mode "${MODE}"

      "$PYTHON_BIN" scripts/03_slopes_visualize.py \
          --input_dir "${RESULTS_DIR_CLUSTER}" \
          --out_dir   "${RESULTS_DIR_CLUSTER}/plots" 
      
      # Phase 5: 崩壊度指標分析
      echo "[${TAG}][${POOL}][${MODE}] Phase 5: collapse analysis"
      "$PYTHON_BIN" scripts/02_collapse_from_logs.py \
          --base_json  "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl" \
          --instr_json "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl" \
          --out_csv    "${RESULTS_DIR_CLUSTER}/collapse_${POOL}_${MODE}.csv" \
          --pooling "${POOL}" \
          --axis_mode "${MODE}"

      "$PYTHON_BIN" scripts/03_collapse_visualize.py \
          --input_path "${RESULTS_DIR_CLUSTER}/collapse_${POOL}_${MODE}.csv" \
          --out_dir    "${RESULTS_DIR_CLUSTER}/plots/collapse"

      "$PYTHON_BIN" scripts/04_repetition_only.py \
        --base_json  "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl" \
        --instr_json "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl" \
        --out_csv    "${RESULTS_DIR_CLUSTER}/repetition_${POOL}_${MODE}.csv" 
        
      "$PYTHON_BIN" scripts/05_repetition_vs_alpha.py \
        --csv     "${RESULTS_DIR_CLUSTER}/repetition_${POOL}_${MODE}.csv" \
        --out_dir "${RESULTS_DIR_CLUSTER}/plots/repetition"
      
      echo "---- ${TAG} / pooling=${POOL} / mode=${MODE} DONE ----"
    done
  done
  echo "==== ${TAG} END: Finished all pooling settings ===="
  echo "-----------------------------------------"
done
# 設定ファイルの復元
echo "[Step 99] Restoring $CONFIG_FILE from $CONFIG_BAK..."
mv "$CONFIG_BAK" "$CONFIG_FILE"

echo "=== EFFICIENT PIPELINE COMPLETED ==="
echo "END TIME: $(date)"

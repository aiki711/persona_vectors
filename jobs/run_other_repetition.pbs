#!/bin/bash
#PBS -N other_repetition_exp
#PBS -q GPU-1
#PBS -o log/all_in_repetition.o%j
#PBS -e log/all_in_repetition.e%j
#PBS -l select=1:ncpus=8:ngpus=1:mem=64gb
#PBS -l walltime=20:00:00
#PBS -j oe

set -euo pipefail

cd "$PBS_O_WORKDIR"
mkdir -p log
exec > >(tee -a "log/all_in_repetition.o${PBS_JOBID}") 2>&1

echo "=== STARTING EFFICIENT FULL EXPERIMENT PIPELINE ==="
echo "START TIME: $(date)"
echo "Host: $(hostname)"
echo "CWD : $PWD"
echo "PBS_JOBID: $PBS_JOBID"

# 0. 設定ファイルのバックアップ
CONFIG_FILE="exp/configs/big5_vectors.yaml"
CONFIG_BAK="exp/configs/big5_vectors.yaml.bak"

if [ ! -f "$CONFIG_BAK" ]; then
    echo "[Step 0] Backing up $CONFIG_FILE to $CONFIG_BAK..."
    cp "$CONFIG_FILE" "$CONFIG_BAK"
else
    echo "[Step 0] Backup $CONFIG_BAK already exists. Restoring from it."
    cp "$CONFIG_BAK" "$CONFIG_FILE"
fi

# ==================== Tokens & PYTHONPATH ===============
export PROJECT_DIR="$PBS_O_WORKDIR"
set +x
if [ -f "$PROJECT_DIR/.hf_token" ]; then
  export HUGGINGFACE_HUB_TOKEN="$(head -n1 "$PROJECT_DIR/.hf_token" | tr -d '\r\n' | sed 's/^Bearer[[:space:]]\+//')"
fi
set -x

export PYTHONPATH="$PROJECT_DIR/src:$PROJECT_DIR:$PROJECT_DIR/scripts:${PYTHONPATH:-}"

export OMP_NUM_THREADS=1
export CUDA_LAUNCH_BLOCKING=1
export HF_HUB_ENABLE_HF_TRANSFER=0
export PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
export TOKENIZERS_PARALLELISM=false

echo "[INFO] nvidia-smi:"
command -v nvidia-smi >/dev/null 2>&1 && nvidia-smi || echo "(no nvidia-smi)"

export PYTHON_BIN="${PYTHON_BIN:-/home/s2550009/anaconda3/envs/mu_base_project/bin/python}"

# ==================== 実験パラメータ ====================
TRAITS=("openness" "conscientiousness" "extraversion" "agreeableness" "neuroticism")
POOLINGS=("asst") #"last"
AXIS_MODES=("pairwise") #"cluster"

# (タグ, BaseID, InstructID)
ALPHAS5_MODEL_PAIRS=(
  "mistral_7b mistralai/Mistral-7B-v0.3 mistralai/Mistral-7B-Instruct-v0.3"
  "llama3_8b meta-llama/Meta-Llama-3-8B meta-llama/Meta-Llama-3-8B-Instruct"
  "llama2_7b  meta-llama/Llama-2-7b-hf       meta-llama/Llama-2-7b-chat-hf"
  "llama2_13b meta-llama/Llama-2-13b-hf      meta-llama/Llama-2-13b-chat-hf"
  "qwen2_7b Qwen/Qwen2-7B Qwen/Qwen2-7B-Instruct"
  "gemma2_9b google/gemma-2-9b google/gemma-2-9b-it"
)
for line in "${ALPHAS5_MODEL_PAIRS[@]}"; do
  set -- $line
  TAG=$1
  BASE_ID=$2
  INSTR_ID=$3

  for MODE in "${AXIS_MODES[@]}"; do
    for POOL in "${POOLINGS[@]}"; do
      echo "==== ${TAG} / pooling=${POOL} / mode=${MODE} ===="
      
      RESULTS_DIR_CLUSTER="exp/${TAG}/${POOL}_${MODE}_results"
      mkdir -p "${RESULTS_DIR_CLUSTER}"

      # Base: probe
      echo "[${TAG}][${POOL}][${MODE}] Base axes"
      sed -i "s|^model_name: .*|model_name: ${BASE_ID}|g" "$CONFIG_FILE"
      
      export POOLING="${POOL}"                      # 00_old 側で読むならここでセット
      export AX_BANK="exp/${TAG}/axes_base_${POOL}_${MODE}.npz"

      # Phase 4: 傾き解析 & 可視化
      echo "[${TAG}][${POOL}][${MODE}] Phase 4: analyze slopes"
      "$PYTHON_BIN" scripts/02_probe_slopes_from_logs.py \
          --base_json  "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl" \
          --instr_json "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl" \
          --out_csv    "${RESULTS_DIR_CLUSTER}/slopes_${POOL}_${MODE}.csv" \
          --pooling "${POOL}" --axis_mode "${MODE}"

      "$PYTHON_BIN" scripts/03_slopes_visualize.py \
          --input_dir "${RESULTS_DIR_CLUSTER}" \
          --out_dir   "${RESULTS_DIR_CLUSTER}/plots" \
          --value_col slope_delta_score_vs_alpha01

      "$PYTHON_BIN" scripts/04_repetition_only.py \
        --base_json  "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl" \
        --instr_json "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl" \
        --out_csv    "${RESULTS_DIR_CLUSTER}/repetition_${POOL}_${MODE}.csv" \
        
      "$PYTHON_BIN" scripts/05_repetition_vs_alpha.py \
        --csv     "${RESULTS_DIR_CLUSTER}/repetition_${POOL}_${MODE}.csv" \
        --out_dir "${RESULTS_DIR_CLUSTER}/plots/repetition"      
      
      echo "---- ${TAG} / pooling=${POOL} / mode=${MODE} DONE ----"
    done
  done
  echo "==== ${TAG} END: Finished all pooling settings ===="
  echo "-----------------------------------------"
done

# 99. 設定ファイルの復元
echo "[Step 99] Restoring $CONFIG_FILE from $CONFIG_BAK..."
mv "$CONFIG_BAK" "$CONFIG_FILE"

echo "=== EFFICIENT PIPELINE COMPLETED ==="
echo "END TIME: $(date)"










for line in "mistral_7b" "llama3_8b" "llama2_7b" "llama2_13b" "qwen2_7b" "gemma2_9b"; do
  set -- $line
  TAG=$1
  RESULTS_DIR_CLUSTER="exp/${TAG}/asst_pairwise_results"
 
  python scripts/02_probe_slopes_from_logs.py \
    --base_json  "${RESULTS_DIR_CLUSTER}/probe_base_alltraits.jsonl" \
    --instr_json "${RESULTS_DIR_CLUSTER}/probe_instruct_alltraits.jsonl" \
    --out_csv    "${RESULTS_DIR_CLUSTER}/slopes_asst_pairwise.csv" \
    --pooling "asst" --axis_mode "pairwise"

  python scripts/03_slopes_visualize.py \
    --input_dir "${RESULTS_DIR_CLUSTER}" \
    --out_dir   "${RESULTS_DIR_CLUSTER}/plots" \
    --value_col slope_delta_score_vs_alpha01

  python scripts/03_slopes_visualize.py \
  --input_dir exp \
  --recursive \
  --file_glob "**/slopes_**_asst_pairwise.csv" \
  --tag_level 0 \
  --out_dir exp/compare_plots/asst_pairwise \
  --value_col slope_delta_score_vs_alpha01
done